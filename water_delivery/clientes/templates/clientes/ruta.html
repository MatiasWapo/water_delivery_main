{% extends 'base.html' %}
{% load static %}

{% block title %}Ruta del Cami√≥n{% endblock %}

{% block content %}
{% csrf_token %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-7xl mx-auto px-2 sm:px-4 md:px-6 lg:px-8">
        
        <!-- Header con informaci√≥n del cami√≥n -->
        <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 header-container">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center space-y-4 lg:space-y-0">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div class="bg-agua-blue p-2 sm:p-3 rounded-full">
                        <i class="fas fa-truck text-white text-xl sm:text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-lg sm:text-2xl font-bold text-gray-900">Ruta del Cami√≥n</h1>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-1 sm:space-y-0 sm:space-x-4 text-xs sm:text-sm text-gray-600">
                            <span id="last-update" class="flex items-center">
                                <i class="fas fa-clock mr-2 text-agua-blue"></i>
                                <span id="update-time">√öltima actualizaci√≥n: --</span>
                            </span>
                            <span id="driver-status" class="flex items-center">
                                <i class="fas fa-user mr-2 text-green-500"></i>
                                <span id="driver-name">Conductor: --</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor del Mapa -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Mapa Principal -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
                    <div class="mb-6">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-900 flex items-center mb-4">
                            <i class="fas fa-map-marked-alt mr-2 text-agua-blue"></i>
                            Ubicaci√≥n en Tiempo Real
                        </h2>
                        <div class="flex flex-col space-y-3 w-full max-w-xs">
                            <button onclick="getMyLocation()"
                                     class="bg-purple-500 text-white px-4 py-3 rounded-lg hover:bg-purple-600 transition-colors text-sm font-medium w-full flex items-center justify-center">
                                <i class="fas fa-location-arrow mr-2"></i>
                                Mi Ubicaci√≥n
                            </button>
                        </div>
                    </div>
                    
                    <!-- Contenedor del Mapa -->
                    <div id="map" class="w-full h-96 sm:h-[500px] lg:h-[600px] rounded-lg border-2 border-gray-200 map-container">
                        <!-- El mapa se cargar√° aqu√≠ -->
                        <div class="w-full h-full flex items-center justify-center bg-gray-100 rounded-lg">
                            <div class="text-center">
                                <i class="fas fa-map text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">Cargando mapa...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel de Informaci√≥n -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 sticky top-6 info-panel">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-agua-blue"></i>
                        Informaci√≥n del Cami√≥n
                    </h3>
                    
                    <!-- Estado del Conductor -->
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Estado del Conductor</h4>
                        <div class="bg-green-50 rounded-lg p-3">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                <span class="text-sm font-medium text-green-700" id="driver-status-text">En l√≠nea</span>
                            </div>
                            <p class="text-xs text-green-600 mt-1" id="driver-last-seen">√öltima actividad: hace 2 min</p>
                        </div>
                        <!-- Informaci√≥n adicional del conductor -->
                        <div id="driver-info" class="mt-3 p-3 bg-gray-50 rounded-lg">
                            <!-- La informaci√≥n se cargar√° din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- Pr√≥ximos Despachos -->
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Pr√≥ximos Despachos</h4>
                        <div id="next-deliveries" class="space-y-2">
                            <div class="text-center py-4 text-gray-500">
                                <i class="fas fa-truck text-2xl mb-2"></i>
                                <p class="text-sm">No hay despachos pendientes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let map;
let truckMarker;
let accuracyCircle;
let totalDistance = 0; // Distancia total recorrida en metros
let lastLocation = null; // √öltima ubicaci√≥n para calcular distancia
let userType = null; // Tipo de usuario (conductor/empresa)
let workDayStart = null; // Inicio del d√≠a de trabajo
let lastActivityTime = null; // √öltima actividad del usuario

// Forzar actualizaci√≥n del nombre del conductor
function forceUpdateConductorName() {
    // Intentar cargar el nombre del conductor inmediatamente
    loadConductorInfo();
    
    // Tambi√©n intentar despu√©s de un peque√±o delay
    setTimeout(() => {
        loadConductorInfo();
    }, 1000);
    
    // Y despu√©s de 3 segundos por si acaso
    setTimeout(() => {
        loadConductorInfo();
    }, 3000);
}

// Inicializaci√≥n cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    // La inicializaci√≥n se hace en el script de verificaci√≥n de Leaflet
    console.log('DOM cargado, esperando Leaflet...');
    
    // Forzar actualizaci√≥n del nombre del conductor
    forceUpdateConductorName();
});

// Verificar y corregir la precisi√≥n del marcador
function verifyMarkerPosition() {
    if (!truckMarker || !window.lastKnownLocation) {
        console.log('No hay marcador o ubicaci√≥n conocida');
        return;
    }
    
    const currentPosition = truckMarker.getLatLng();
    const expectedPosition = window.lastKnownLocation;
    
    console.log('Verificando posici√≥n del marcador:');
    console.log('- Posici√≥n actual:', currentPosition);
    console.log('- Posici√≥n esperada:', expectedPosition);
    
    // Si hay diferencia, corregir
    if (currentPosition.lat !== expectedPosition[0] || currentPosition.lng !== expectedPosition[1]) {
        console.log('Corrigiendo posici√≥n del marcador...');
        truckMarker.setLatLng(expectedPosition);
        map.setView(expectedPosition, 16);
    }
}

// Funci√≥n de debug para verificar el marcador
function debugMarker() {
    const markerInfo = {
        exists: !!truckMarker,
        position: truckMarker ? truckMarker.getLatLng() : null,
        isVisible: truckMarker ? truckMarker.getElement() : null,
        mapCenter: map ? map.getCenter() : null,
        lastKnownLocation: window.lastKnownLocation || 'No disponible',
        accuracyCircle: !!accuracyCircle,
        accuracyRadius: accuracyCircle ? accuracyCircle.getRadius() : null
    };
    
    console.log('=== DEBUG DEL MARCADOR ===');
    console.log('Estado del marcador:', markerInfo);
    
    // Verificar precisi√≥n del marcador
    verifyMarkerPosition();
    
    // Mostrar alerta con informaci√≥n del marcador
    let alertMessage = `üîç DEBUG DEL MARCADOR\n\n`;
    alertMessage += `‚úÖ Existe: ${markerInfo.exists ? 'S√≠' : 'No'}\n`;
    alertMessage += `üìç Posici√≥n: ${markerInfo.position ? `${markerInfo.position.lat.toFixed(6)}, ${markerInfo.position.lng.toFixed(6)}` : 'No disponible'}\n`;
    alertMessage += `üëÅÔ∏è Visible: ${markerInfo.isVisible ? 'S√≠' : 'No'}\n`;
    alertMessage += `üó∫Ô∏è Centro del mapa: ${markerInfo.mapCenter ? `${markerInfo.mapCenter.lat.toFixed(6)}, ${markerInfo.mapCenter.lng.toFixed(6)}` : 'No disponible'}\n`;
    alertMessage += `üíæ √öltima ubicaci√≥n conocida: ${markerInfo.lastKnownLocation}\n`;
    alertMessage += `‚≠ï C√≠rculo de precisi√≥n: ${markerInfo.accuracyCircle ? 'S√≠' : 'No'}\n`;
    alertMessage += `üìè Radio de precisi√≥n: ${markerInfo.accuracyRadius ? `${markerInfo.accuracyRadius}m` : 'No disponible'}`;
    
    alert(alertMessage);
    
    if (truckMarker) {
        // Forzar la actualizaci√≥n del marcador
        truckMarker.setLatLng(truckMarker.getLatLng());
        console.log('‚úÖ Marcador actualizado');
    }
    
    console.log('=== FIN DEBUG ===');
}

// Inicializar el mapa
function initializeMap() {
    // Coordenadas por defecto (Venezuela)
    const defaultLocation = [10.4806, -66.9036];
    
    // Crear el mapa con OpenStreetMap
    map = L.map('map').setView(defaultLocation, 12);
    
    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    
    // Crear marcador del cami√≥n como c√≠rculo azul
    truckMarker = L.circle(defaultLocation, {
        color: '#0891b2',
        fillColor: '#0891b2',
        fillOpacity: 0.8,
        radius: 20, // Radio en metros
        weight: 3
    }).addTo(map);
    
    // Debug del marcador (deshabilitado)
    // setTimeout(debugMarker, 1000);
    
    // Intentar obtener la ubicaci√≥n real del usuario al inicializar
    getMyLocation();
}

// Calcular distancia entre dos puntos (f√≥rmula de Haversine)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Radio de la Tierra en metros
    const œÜ1 = lat1 * Math.PI/180;
    const œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
            Math.cos(œÜ1) * Math.cos(œÜ2) *
            Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // Distancia en metros
}

// Cargar despachos de hoy desde la API
async function loadDespachosHoy() {
    // Esta funci√≥n ya no es necesaria en la ruta del cami√≥n
    // Los despachos se muestran en el header principal
    console.log('‚ÑπÔ∏è Despachos de hoy se muestran en el header principal');
}

// Actualizar despachos peri√≥dicamente
function startDespachosUpdate() {
    // Esta funci√≥n ya no es necesaria en la ruta del cami√≥n
    console.log('‚ÑπÔ∏è Actualizaci√≥n de despachos manejada por el header principal');
}

// Cargar informaci√≥n del usuario conductor conectado
async function loadConductorInfo() {
    try {
        const response = await fetch('/clientes/api/conductor-info/');
        const data = await response.json();
        
        if (data.success) {
            const conductorName = data.conductor_name || 'Usuario';
            const driverNameElement = document.getElementById('driver-name');
            if (driverNameElement) {
                driverNameElement.textContent = `Conductor: ${conductorName}`;
                console.log('‚úÖ Informaci√≥n del conductor cargada:', conductorName);
            } else {
                console.error('‚ùå Elemento driver-name no encontrado');
            }
        } else {
            console.error('‚ùå Error cargando informaci√≥n del conductor:', data.message);
            // Fallback: usar nombre por defecto
            const driverNameElement = document.getElementById('driver-name');
            if (driverNameElement) {
                driverNameElement.textContent = 'Conductor: Usuario';
            }
        }
    } catch (error) {
        console.error('‚ùå Error en la petici√≥n del conductor:', error);
        // Fallback: usar nombre por defecto
        const driverNameElement = document.getElementById('driver-name');
        if (driverNameElement) {
            driverNameElement.textContent = 'Conductor: Usuario';
        }
    }
}

// Actualizar distancia recorrida
function updateDistanceTraveled(newLat, newLng) {
    // Verificar si es un nuevo d√≠a de trabajo
    isNewWorkDay();
    
    // Solo actualizar distancia si es conductor
    if (userType !== 'conductor') {
        return;
    }
    
    if (lastLocation) {
        const distance = calculateDistance(
            lastLocation.lat, 
            lastLocation.lng, 
            newLat, 
            newLng
        );
        
        // Solo agregar si la distancia es significativa (m√°s de 10 metros)
        if (distance > 10) {
            totalDistance += distance;
            console.log(`üìè Distancia agregada: ${distance.toFixed(2)}m, Total: ${totalDistance.toFixed(2)}m`);
        }
    }
    
    // Actualizar √∫ltima ubicaci√≥n
    lastLocation = { lat: newLat, lng: newLng };
    
    // Actualizar tiempo de actividad
    updateLastActivity();
    
    // Actualizar display de distancia con formato mejorado
    const distanceElement = document.getElementById('distance-traveled');
    if (distanceElement) {
        if (totalDistance < 1000) {
            // Si es menos de 1km, mostrar en metros redondeados
            distanceElement.textContent = `${Math.round(totalDistance)}m`;
        } else if (totalDistance < 10000) {
            // Si es entre 1km y 10km, mostrar con un decimal
            distanceElement.textContent = `${(totalDistance/1000).toFixed(1)}km`;
        } else {
            // Si es m√°s de 10km, mostrar sin decimales
            distanceElement.textContent = `${Math.round(totalDistance/1000)}km`;
        }
    }
}

// Cargar estado del conductor
function loadDriverStatus() {
    // Simular datos del conductor (aqu√≠ se conectar√≠a con la API real)
    const driverData = {
        name: 'Carlos P√©rez',
        status: 'En l√≠nea',
        lastSeen: 'hace 2 minutos',
        location: 'Ubicaci√≥n actual',
        signal: 'Buena'
    };
    
    // El nombre se cargar√° desde la API
    // document.getElementById('driver-name').textContent = `Conductor: ${driverData.name}`;
    document.getElementById('driver-status-text').textContent = driverData.status;
    
    // Actualizar tiempo de √∫ltima actividad
    updateLastActivity();
    
    // Actualizar informaci√≥n adicional si existe
    const driverInfoContainer = document.getElementById('driver-info');
    if (driverInfoContainer) {
        driverInfoContainer.innerHTML = `
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Se√±al GPS:</span>
                    <span class="font-semibold ${driverData.signal === 'Buena' ? 'text-green-600' : driverData.signal === 'Regular' ? 'text-yellow-600' : 'text-red-600'}">${driverData.signal}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Distancia recorrida:</span>
                    <span class="font-semibold text-green-600" id="distance-traveled">0m</span>
                </div>
                <div class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    "En l√≠nea" indica que el usuario est√° activo en el sistema
                </div>
            </div>
        `;
    }
}

// Cargar pr√≥ximos despachos
function loadNextDeliveries() {
    // Simular datos de despachos (aqu√≠ se conectar√≠a con la API real)
    const deliveries = [
        { id: 1, client: 'Juan P√©rez', address: 'Calle 123, Caracas', time: '14:30' },
        { id: 2, client: 'Mar√≠a Garc√≠a', address: 'Av. Principal, Caracas', time: '15:00' }
    ];
    
    const container = document.getElementById('next-deliveries');
    
    if (deliveries.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <i class="fas fa-truck text-2xl mb-2"></i>
                <p class="text-sm">No hay despachos pendientes</p>
            </div>
        `;
    } else {
        container.innerHTML = deliveries.map(delivery => `
            <div class="bg-gray-50 rounded-lg p-3">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h5 class="text-sm font-semibold text-gray-900">${delivery.client}</h5>
                        <p class="text-xs text-gray-600">${delivery.address}</p>
                    </div>
                    <span class="text-xs bg-agua-blue text-white px-2 py-1 rounded">${delivery.time}</span>
                </div>
            </div>
        `).join('');
    }
}

// Actualizar tiempo de √∫ltima actualizaci√≥n
function updateLastUpdate() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('es-VE', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    document.getElementById('update-time').textContent = `√öltima actualizaci√≥n: ${timeString}`;
}

// Limpiar mensajes de precisi√≥n anteriores
function clearPrecisionMessages() {
    const existingMessages = document.querySelectorAll('.bg-green-100.border.border-green-400');
    existingMessages.forEach(message => message.remove());
}

// Obtener direcci√≥n real usando coordenadas
async function getAddressFromCoords(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
        const data = await response.json();
        
        if (data.display_name) {
            // Extraer solo la parte m√°s relevante de la direcci√≥n
            const addressParts = data.display_name.split(',');
            return addressParts.slice(0, 3).join(', '); // Tomar solo las primeras 3 partes
        }
        return 'Ubicaci√≥n actual';
    } catch (error) {
        console.error('Error obteniendo direcci√≥n:', error);
        return 'Ubicaci√≥n actual';
    }
}

// Actualizar informaci√≥n del conductor con ubicaci√≥n real
async function updateDriverLocation(lat, lng) {
    const address = await getAddressFromCoords(lat, lng);
    
    const driverInfoContainer = document.getElementById('driver-info');
    if (driverInfoContainer) {
        driverInfoContainer.innerHTML = `
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Se√±al GPS:</span>
                    <span class="font-semibold text-green-600">Buena</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Distancia recorrida:</span>
                    <span class="font-semibold text-green-600" id="distance-traveled">0m</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Ubicaci√≥n:</span>
                    <span class="font-semibold text-gray-800 text-xs">${address}</span>
                </div>
            </div>
        `;
    }
}

// Centrar marcador en ubicaci√≥n exacta
function centerMarkerOnLocation(lat, lng) {
    if (!truckMarker) {
        console.error('No hay marcador disponible');
        return;
    }
    
    const exactLocation = [lat, lng];
    
    // Actualizar distancia recorrida
    updateDistanceTraveled(lat, lng);
    
    // Posicionar marcador en ubicaci√≥n exacta
    truckMarker.setLatLng(exactLocation);
    
    // Centrar mapa en la ubicaci√≥n exacta
    map.setView(exactLocation, 16);
    
    // Guardar ubicaci√≥n exacta
    window.lastKnownLocation = exactLocation;
    
    console.log('‚úÖ Marcador centrado en ubicaci√≥n exacta:', exactLocation);
}

// Seguimiento continuo de ubicaci√≥n
function startContinuousTracking() {
    if (navigator.geolocation) {
        // Configurar seguimiento continuo
        navigator.geolocation.watchPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                console.log('üìç Ubicaci√≥n actualizada:', { lat, lng, accuracy });
                
                // Actualizar marcador sin mostrar mensajes
                centerMarkerOnLocation(lat, lng);
                
                // Actualizar c√≠rculo de precisi√≥n
                if (accuracyCircle) {
                    map.removeLayer(accuracyCircle);
                }
                
                accuracyCircle = L.circle([lat, lng], {
                    color: '#3B82F6',
                    fillColor: '#3B82F6',
                    fillOpacity: 0.2,
                    radius: accuracy
                }).addTo(map);
                
                // Actualizar timestamp
                updateLastUpdate();
                
                // Enviar ubicaci√≥n al servidor
                saveLocationToServer(lat, lng, accuracy);
            },
            function(error) {
                console.error('Error en seguimiento continuo:', error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 30000 // Actualizar cada 30 segundos
            }
        );
        
        console.log('üîÑ Seguimiento continuo iniciado');
    }
}

// Obtener ubicaci√≥n real del usuario
function getMyLocation() {
    // Verificar si es conductor
    if (userType !== 'conductor') {
        showMessage('Solo los conductores pueden usar la funci√≥n de ubicaci√≥n', 'error');
        return;
    }
    
    if (navigator.geolocation) {
        showMessage('Obteniendo tu ubicaci√≥n...', 'info');
        
        navigator.geolocation.getCurrentPosition(
            async function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                console.log('Ubicaci√≥n real obtenida:', { lat, lng, accuracy });
                
                // Limpiar mensajes anteriores
                clearPrecisionMessages();
                
                // Centrar marcador en ubicaci√≥n exacta
                centerMarkerOnLocation(lat, lng);
                
                // Crear o actualizar c√≠rculo de precisi√≥n (solo azul, no verde)
                if (accuracyCircle) {
                    map.removeLayer(accuracyCircle);
                }
                
                accuracyCircle = L.circle([lat, lng], {
                    color: '#3B82F6',
                    fillColor: '#3B82F6',
                    fillOpacity: 0.2,
                    radius: accuracy // Radio en metros
                }).addTo(map);
                
                // Actualizar informaci√≥n del conductor con ubicaci√≥n real
                await updateDriverLocation(lat, lng);
                
                // Mostrar informaci√≥n de precisi√≥n en el header
                const precisionElement = document.createElement('div');
                precisionElement.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4 animate-fade-in precision-message';
                precisionElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span>Seguimiento activo - Precisi√≥n: ¬±${Math.round(accuracy)}m</span>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-green-600 hover:text-green-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                // Insertar el mensaje de precisi√≥n despu√©s del header
                const header = document.querySelector('.header-container');
                if (header && !document.querySelector('.precision-message')) {
                    header.parentNode.insertBefore(precisionElement, header.nextSibling);
                    
                    // Auto-ocultar despu√©s de 5 segundos
                    setTimeout(() => {
                        if (precisionElement.parentNode) {
                            precisionElement.style.transition = 'opacity 0.5s ease-out';
                            precisionElement.style.opacity = '0';
                            setTimeout(() => {
                                if (precisionElement.parentNode) {
                                    precisionElement.remove();
                                }
                            }, 500);
                        }
                    }, 5000);
                }
                
                // Actualizar timestamp
                updateLastUpdate();
                
                // Aqu√≠ podr√≠as enviar la ubicaci√≥n al servidor
                saveLocationToServer(lat, lng, accuracy);
                
                // Iniciar seguimiento continuo
                startContinuousTracking();
                
                // NO ejecutar debug autom√°ticamente aqu√≠
            },
            function(error) {
                console.error('Error obteniendo ubicaci√≥n:', error);
                let errorMessage = 'Error obteniendo ubicaci√≥n';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Permiso denegado. Habilita la ubicaci√≥n en tu navegador.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Ubicaci√≥n no disponible.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Tiempo de espera agotado.';
                        break;
                }
                
                showMessage(errorMessage, 'error');
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    } else {
        showMessage('Geolocalizaci√≥n no soportada en este navegador', 'error');
    }
}

// Guardar ubicaci√≥n en el servidor
function saveLocationToServer(lat, lng, accuracy) {
    // Guardar la ubicaci√≥n en una variable global para uso posterior
    window.lastKnownLocation = [lat, lng];
    
    // Aqu√≠ implementar√≠as el env√≠o al servidor
    console.log('Guardando ubicaci√≥n en servidor:', { lat, lng, accuracy });
    
    // Simulaci√≥n de env√≠o al servidor
    fetch('/clientes/api/guardar-ubicacion/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            latitud: lat,
            longitud: lng,
            precision: accuracy,
            timestamp: new Date().toISOString()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Ubicaci√≥n guardada exitosamente');
        } else {
            console.error('Error guardando ubicaci√≥n:', data.message);
        }
    })
    .catch(error => {
        console.error('Error en la petici√≥n:', error);
    });
}

// Mostrar mensaje
function showMessage(message, type) {
    const toast = document.createElement('div');
    let bgColor, icon;
    
    switch(type) {
        case 'success':
            bgColor = 'bg-green-500 text-white';
            icon = 'fa-check-circle';
            break;
        case 'error':
            bgColor = 'bg-red-500 text-white';
            icon = 'fa-exclamation-circle';
            break;
        case 'info':
            bgColor = 'bg-blue-500 text-white';
            icon = 'fa-info-circle';
            break;
        default:
            bgColor = 'bg-gray-500 text-white';
            icon = 'fa-info-circle';
    }
    
    toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${bgColor} toast-message`;
    toast.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="fas ${icon}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Verificar si es un nuevo d√≠a de trabajo (7AM-6PM UTC-4)
function isNewWorkDay() {
    const now = new Date();
    const venezuelaTime = new Date(now.getTime() - (4 * 60 * 60 * 1000)); // UTC-4
    const currentHour = venezuelaTime.getHours();
    
    // Si es entre 7AM y 6PM
    if (currentHour >= 7 && currentHour < 18) {
        const today = venezuelaTime.toDateString();
        
        // Si no hay fecha de inicio o es un d√≠a diferente
        if (!workDayStart || workDayStart !== today) {
            workDayStart = today;
            totalDistance = 0; // Resetear distancia
            console.log('üîÑ Nuevo d√≠a de trabajo - Distancia reseteada');
            return true;
        }
    }
    
    return false;
}

// Actualizar tiempo de √∫ltima actividad
function updateLastActivity() {
    lastActivityTime = new Date();
    const timeString = lastActivityTime.toLocaleTimeString('es-VE', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    const lastSeenElement = document.getElementById('driver-last-seen');
    if (lastSeenElement) {
        lastSeenElement.textContent = `√öltima actividad: ${timeString}`;
    }
}

// Cargar informaci√≥n del usuario y verificar tipo
async function loadUserInfo() {
    try {
        const response = await fetch('/clientes/api/conductor-info/');
        const data = await response.json();
        
        if (data.success) {
            userType = 'conductor';
            const conductorName = data.conductor_name || 'Conductor';
            const driverNameElement = document.getElementById('driver-name');
            if (driverNameElement) {
                driverNameElement.textContent = `Conductor: ${conductorName}`;
            }
            console.log('‚úÖ Usuario conductor detectado:', conductorName);
        } else {
            userType = 'empresa';
            const driverNameElement = document.getElementById('driver-name');
            if (driverNameElement) {
                driverNameElement.textContent = 'Usted es usuario empresa';
            }
            
            // Mostrar aviso para empresa
            showMessage('Usted es usuario empresa. No se puede mostrar su ubicaci√≥n en el mapa. Solo los conductores pueden usar esta funci√≥n.', 'info');
            
            // Deshabilitar bot√≥n de ubicaci√≥n
            const locationButton = document.querySelector('button[onclick="getMyLocation()"]');
            if (locationButton) {
                locationButton.disabled = true;
                locationButton.className = 'bg-gray-400 text-white px-3 py-2 rounded-lg transition-colors text-sm opacity-50 cursor-not-allowed';
                locationButton.innerHTML = '<i class="fas fa-location-arrow mr-1"></i>No disponible';
            }
            
            console.log('‚ÑπÔ∏è Usuario empresa detectado');
        }
    } catch (error) {
        console.error('‚ùå Error cargando informaci√≥n del usuario:', error);
        userType = 'empresa';
        const driverNameElement = document.getElementById('driver-name');
        if (driverNameElement) {
            driverNameElement.textContent = 'Usuario: No identificado';
        }
    }
}
</script>

<style>
/* ESTILOS CORREGIDOS PARA Z-INDEX */

/* Contenedores principales con z-index bajo */
.header-container {
    position: relative;
    z-index: 10;
}

.map-container {
    position: relative;
    z-index: 1;
}

.info-panel {
    position: relative;
    z-index: 10;
}

/* Mapa y Leaflet con z-index muy bajo */
#map {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    z-index: 1 !important;
}

.leaflet-container {
    z-index: 1 !important;
    border-radius: 8px;
}

.leaflet-control-container {
    z-index: 2 !important;
}

/* C√≠rculo del cami√≥n */
.leaflet-circle {
    z-index: 3 !important;
}

/* Mensajes de toast con z-index alto pero menor que el men√∫ m√≥vil */
.toast-message {
    z-index: 8000 !important;
}

/* Mensajes de precisi√≥n */
.precision-message {
    z-index: 100 !important;
}

/* NAVEGACI√ìN - Z-INDEX CORREGIDO */
/* Header/navbar principal debe estar por debajo del men√∫ m√≥vil */
nav, .navbar, header, .bg-gradient-to-r {
    z-index: 1000 !important;
    position: relative;
}

/* MEN√ö M√ìVIL - Z-INDEX M√ÅS ALTO */
.mobile-menu, 
.mobile-menu-overlay,
[data-mobile-menu],
.sidebar-mobile,
.offcanvas,
.drawer {
    z-index: 9999 !important;
    position: fixed !important;
}

/* Bot√≥n del men√∫ m√≥vil */
.mobile-menu-button,
.hamburger-menu,
[data-mobile-menu-button] {
    z-index: 10000 !important;
    position: relative;
}

/* Overlay del men√∫ m√≥vil */
.mobile-menu-backdrop,
.menu-overlay {
    z-index: 9998 !important;
    position: fixed !important;
}

/* Asegurar que el contenido principal est√© por debajo */
main, .main-content, .container {
    z-index: 1 !important;
    position: relative;
}

/* Animaci√≥n para alertas */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fadeIn 0.3s ease-out;
}

/* Estilos para Leaflet */
.leaflet-popup-content-wrapper {
    border-radius: 8px;
}

.leaflet-popup-tip {
    background: white;
}

/* Estilos para el panel de informaci√≥n */
.sticky {
    position: sticky;
    top: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    #map {
        height: 300px;
    }
    
    /* En m√≥vil, asegurar que el men√∫ tenga la m√°xima prioridad */
    .mobile-menu {
        z-index: 99999 !important;
    }
    
    /* Header en m√≥vil debe estar m√°s bajo */
    .header-container {
        z-index: 5 !important;
    }
}

/* Estilos adicionales para evitar conflictos */
.leaflet-top,
.leaflet-bottom {
    z-index: 2 !important;
}

.leaflet-control {
    z-index: 2 !important;
}

/* Asegurar que los elementos del mapa no interfieran */
.leaflet-marker-icon,
.leaflet-marker-shadow {
    z-index: 3 !important;
}

.leaflet-popup {
    z-index: 4 !important;
}
</style>

<!-- Leaflet CSS y JS (OpenStreetMap) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Verificar que Leaflet se carg√≥ correctamente
document.addEventListener('DOMContentLoaded', function() {
    if (typeof L === 'undefined') {
        console.error('Leaflet no se carg√≥ correctamente');
        document.getElementById('map').innerHTML = `
            <div class="w-full h-full flex items-center justify-center bg-red-100 rounded-lg">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <p class="text-red-600 font-semibold">Error cargando el mapa</p>
                    <p class="text-red-500 text-sm">Verifica tu conexi√≥n a internet</p>
                </div>
            </div>
        `;
    } else {
        console.log('Leaflet cargado correctamente');
        // Inicializar el mapa despu√©s de verificar que Leaflet est√° disponible
        initializeMap();
        loadDriverStatus();
        loadNextDeliveries();
        loadUserInfo(); // Cargar informaci√≥n del usuario y verificar tipo
    }
});
</script>
{% endblock %}
